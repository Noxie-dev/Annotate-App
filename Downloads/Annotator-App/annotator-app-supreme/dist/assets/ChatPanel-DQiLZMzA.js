var Je=Object.defineProperty;var Xe=(r,t,a)=>t in r?Je(r,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):r[t]=a;var _=(r,t,a)=>Xe(r,typeof t!="symbol"?t+"":t,a);import{j as e,a2 as Pe,a3 as Ze,a4 as es,a5 as $e,a6 as ss,a7 as as,a8 as ts,a9 as rs,aa as ns,ab as ze}from"./radix-ui-Dm4GcI-M.js";import{a as l}from"./react-vendor-BxpQIQ7B.js";import{b as Ie}from"./index-CeiQEl0I.js";import{l as is}from"./webrtc-vendor-B72qc5dU.js";import{c as ls}from"./data-vendor-7zrJSdJt.js";import{B as j,c as ke}from"./button-BU14-tcR.js";import{I as cs}from"./input-B_Pc9ca6.js";import{A as te,a as re,b as ne}from"./avatar-Dqh11rFN.js";import{B as ie}from"./badge-CzkljnjK.js";import{D as Ne,a as Ce,b as we,c as K}from"./dropdown-menu-EF7jn1zy.js";import{al as Te,am as Oe,a5 as le,an as os,ao as ds,ap as us,s as _e,x as Me,aq as xe,V as ce,ar as De,as as ms,at as hs,i as Se,au as gs,av as He,j as fs,aw as xs,ak as ps,J as Fe,ax as vs,ay as bs,az as js,aA as ys,aB as Ns,aC as Cs,aD as ws}from"./utils-vendor-DzewcVAv.js";import{L as H}from"./label--JKAZs82.js";import{D as We,j as Ss,a as Le,b as Ge,c as qe,d as Be,S as de,f as ue,g as me,h as he,i as ee}from"./select-BvRLeJVF.js";import{S as Ae,a as be}from"./UserProfile-CR6JMFRa.js";import{T as Es,a as Is,b as je,c as ye}from"./tabs-C8PfzfW2.js";import"./card-BRJUXXhw.js";import"./pdf-vendor-BQ5_-Qxz.js";import"./form-vendor-B0nP1T3w.js";import"./zod-CPQLszjv.js";import"./profile-vendor-CNRlCIDN.js";import"./separator-UVofwG_Y.js";const Qe=["stun:stun.l.google.com:19302","stun:stun1.l.google.com:19302","stun:stun2.l.google.com:19302","stun:stun3.l.google.com:19302","stun:stun4.l.google.com:19302"],ks=["stun:stun.stunprotocol.org:3478","stun:stun.voiparound.com","stun:stun.voipbuster.com"],Ts={iceServers:[{urls:Qe},{urls:ks}],iceTransportPolicy:"all",iceCandidatePoolSize:10},Rs={iceServers:[{urls:Qe}],iceTransportPolicy:"all",iceCandidatePoolSize:10},Ms={iceServers:[],iceTransportPolicy:"relay",iceCandidatePoolSize:10};function Ds(){switch("production"){case"production":return Rs;case"test":return Ms;default:return Ts}}function As(r){if(!r.iceServers||r.iceServers.length===0)return console.warn("WebRTC config has no ICE servers"),!1;let t=!1,a=!1;return r.iceServers.forEach(s=>{(Array.isArray(s.urls)?s.urls:[s.urls]).forEach(o=>{o.startsWith("stun:")?t=!0:(o.startsWith("turn:")||o.startsWith("turns:"))&&(a=!0,(!s.username||!s.credential)&&console.warn("TURN server configured without credentials"))})}),t||console.warn("WebRTC config has no STUN servers - NAT traversal may fail"),a||console.info("WebRTC config has no TURN servers - connections may fail behind restrictive firewalls"),!0}const Us={hasTurnCredentials(){return!1},getSignalingServerUrl(){return"ws://localhost:3001"},isDevelopment(){return!1},isProduction(){return!0}},Vs=Ds(),ge=ls((r,t)=>({config:Vs,peerConnections:new Map,isInCall:!1,isInitiating:!1,isReceivingCall:!1,callId:null,localStream:null,remoteStreams:new Map,participants:[],isVideoEnabled:!0,isAudioEnabled:!0,isSharingScreen:!1,callStartTime:null,callDuration:0,lastError:null,initializeWebRTC:async()=>{try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("WebRTC is not supported in this browser");const a=t().config;As(a)||console.warn("WebRTC configuration validation failed, but continuing..."),console.log("WebRTC initialized successfully with config:",a)}catch(a){console.error("Failed to initialize WebRTC:",a),r({lastError:a instanceof Error?a.message:"Unknown error"})}},startCall:async a=>{const s=t();if(s.isInCall)throw new Error("Already in a call");try{r({isInitiating:!0,lastError:null});const n=await navigator.mediaDevices.getUserMedia({video:s.isVideoEnabled,audio:s.isAudioEnabled}),o=`call-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;r({localStream:n,callId:o,isInCall:!0,isInitiating:!1,callStartTime:new Date,participants:[{userId:"current-user",isVideoEnabled:s.isVideoEnabled,isAudioEnabled:s.isAudioEnabled,isSharingScreen:!1}]}),await t().createPeerConnection(a),console.log(`Call started with ${a}`)}catch(n){throw console.error("Failed to start call:",n),r({isInitiating:!1,lastError:n instanceof Error?n.message:"Failed to start call"}),n}},acceptCall:async a=>{try{r({isReceivingCall:!1,lastError:null});const s=await navigator.mediaDevices.getUserMedia({video:t().isVideoEnabled,audio:t().isAudioEnabled});r({localStream:s,callId:a,isInCall:!0,callStartTime:new Date}),console.log(`Call accepted: ${a}`)}catch(s){throw console.error("Failed to accept call:",s),r({isReceivingCall:!1,lastError:s instanceof Error?s.message:"Failed to accept call"}),s}},rejectCall:a=>{r({isReceivingCall:!1,callId:null,lastError:null}),console.log(`Call rejected: ${a}`)},endCall:()=>{const a=t();a.localStream&&a.localStream.getTracks().forEach(s=>s.stop()),a.peerConnections.forEach(s=>{s.connection.close()}),r({isInCall:!1,isInitiating:!1,isReceivingCall:!1,callId:null,localStream:null,remoteStreams:new Map,participants:[],callStartTime:null,callDuration:0,peerConnections:new Map,isSharingScreen:!1}),console.log("Call ended")},toggleVideo:async()=>{const a=t(),s=!a.isVideoEnabled;if(a.localStream){const n=a.localStream.getVideoTracks()[0];n&&(n.enabled=s)}r({isVideoEnabled:s}),t().updateParticipant("current-user",{isVideoEnabled:s})},toggleAudio:async()=>{const a=t(),s=!a.isAudioEnabled;if(a.localStream){const n=a.localStream.getAudioTracks()[0];n&&(n.enabled=s)}r({isAudioEnabled:s}),t().updateParticipant("current-user",{isAudioEnabled:s})},toggleScreenShare:async()=>{const a=t();try{if(a.isSharingScreen){if(a.localStream){const s=a.localStream.getVideoTracks()[0];a.peerConnections.forEach(n=>{const o=n.connection.getSenders().find(d=>d.track&&d.track.kind==="video");o&&s&&o.replaceTrack(s)})}r({isSharingScreen:!1})}else{const s=await navigator.mediaDevices.getDisplayMedia({video:!0,audio:!0});a.peerConnections.forEach(n=>{const o=n.connection.getSenders().find(d=>d.track&&d.track.kind==="video");o&&s.getVideoTracks()[0]&&o.replaceTrack(s.getVideoTracks()[0])}),r({isSharingScreen:!0}),s.getVideoTracks()[0].onended=()=>{t().toggleScreenShare()}}t().updateParticipant("current-user",{isSharingScreen:!a.isSharingScreen})}catch(s){console.error("Failed to toggle screen share:",s),r({lastError:s instanceof Error?s.message:"Screen share failed"})}},handleSignalingMessage:async a=>{console.log("Received signaling message:",a)},createPeerConnection:async a=>{const s=t();try{const n=new RTCPeerConnection(s.config);s.localStream&&s.localStream.getTracks().forEach(d=>{n.addTrack(d,s.localStream)}),n.ontrack=d=>{const p=d.streams[0];r(C=>({remoteStreams:new Map(C.remoteStreams.set(a,p))}))},n.onicecandidate=d=>{d.candidate&&console.log("ICE candidate:",d.candidate)},n.onconnectionstatechange=()=>{console.log(`Connection state for ${a}:`,n.connectionState),(n.connectionState==="failed"||n.connectionState==="disconnected")&&t().removeParticipant(a)};const o={id:`peer-${a}-${Date.now()}`,userId:a,connection:n,localStream:s.localStream||void 0,connectionState:n.connectionState,iceConnectionState:n.iceConnectionState};return r(d=>({peerConnections:new Map(d.peerConnections.set(a,o))})),n}catch(n){throw console.error(`Failed to create peer connection for ${a}:`,n),n}},addParticipant:a=>{r(s=>({participants:[...s.participants.filter(n=>n.userId!==a.userId),a]}))},removeParticipant:a=>{const n=t().peerConnections.get(a);n&&n.connection.close(),r(o=>({participants:o.participants.filter(d=>d.userId!==a),peerConnections:new Map([...o.peerConnections].filter(([d])=>d!==a)),remoteStreams:new Map([...o.remoteStreams].filter(([d])=>d!==a))}))},updateParticipant:(a,s)=>{r(n=>({participants:n.participants.map(o=>o.userId===a?{...o,...s}:o)}))},setError:a=>{r({lastError:a})},cleanup:()=>{const a=t();a.localStream&&a.localStream.getTracks().forEach(s=>s.stop()),a.peerConnections.forEach(s=>{s.connection.close()}),r({isInCall:!1,isInitiating:!1,isReceivingCall:!1,callId:null,localStream:null,remoteStreams:new Map,participants:[],callStartTime:null,callDuration:0,peerConnections:new Map,isSharingScreen:!1,lastError:null})}}));class Ps{constructor(t){_(this,"socket",null);_(this,"config");_(this,"messageHandlers",new Map);_(this,"connectionHandlers",new Map);_(this,"isConnected",!1);this.config=t,t.autoConnect!==!1&&this.connect()}connect(){return new Promise((t,a)=>{try{this.socket=is(this.config.serverUrl,{transports:["websocket"],auth:{userId:this.config.userId,documentId:this.config.documentId},reconnection:!0,reconnectionAttempts:5,reconnectionDelay:1e3,timeout:1e4}),this.socket.on("connect",()=>{console.log("Connected to signaling server"),this.isConnected=!0,this.config.documentId&&this.socket.emit("join-document",this.config.documentId),this.connectionHandlers.forEach(s=>s()),t()}),this.socket.on("disconnect",s=>{console.log("Disconnected from signaling server:",s),this.isConnected=!1}),this.socket.on("connect_error",s=>{console.error("Signaling connection error:",s),a(s)}),this.socket.on("webrtc-signal",s=>{console.log("Received WebRTC signal:",s),this.messageHandlers.forEach(n=>n(s))}),this.socket.on("call-request",s=>{const n={type:"call-request",callId:s.callId,fromUserId:s.fromUserId,data:{fromUserName:s.fromUserName}};this.messageHandlers.forEach(o=>o(n))}),this.socket.on("call-response",s=>{const n={type:s.accepted?"call-accept":"call-reject",callId:s.callId,fromUserId:s.fromUserId};this.messageHandlers.forEach(o=>o(n))}),this.socket.on("call-ended",s=>{const n={type:"call-end",callId:s.callId,fromUserId:s.fromUserId};this.messageHandlers.forEach(o=>o(n))}),this.socket.on("participant-update",s=>{const n={type:"participant-update",callId:s.callId,fromUserId:s.fromUserId,data:s.updates};this.messageHandlers.forEach(o=>o(n))})}catch(s){a(s)}})}disconnect(){this.socket&&(this.socket.disconnect(),this.socket=null,this.isConnected=!1)}sendSignalingMessage(t){if(!this.socket||!this.isConnected){console.error("Cannot send message: not connected to signaling server");return}console.log("Sending WebRTC signal:",t),this.socket.emit("webrtc-signal",t)}sendCallRequest(t,a,s){if(!this.socket||!this.isConnected){console.error("Cannot send call request: not connected to signaling server");return}console.log(`Sending call request to ${t}`),this.socket.emit("call-request",{targetUserId:t,callId:a,fromUserId:this.config.userId,fromUserName:s})}respondToCall(t,a,s){if(!this.socket||!this.isConnected){console.error("Cannot respond to call: not connected to signaling server");return}console.log(`Responding to call ${t}: ${a?"accepted":"rejected"}`),this.socket.emit("call-response",{callId:t,accepted:a,targetUserId:s,fromUserId:this.config.userId})}endCall(t,a){if(!this.socket||!this.isConnected){console.error("Cannot end call: not connected to signaling server");return}console.log(`Ending call ${t}`),this.socket.emit("call-end",{callId:t,targetUserId:a,fromUserId:this.config.userId})}sendParticipantUpdate(t,a,s){if(!this.socket||!this.isConnected){console.error("Cannot send participant update: not connected to signaling server");return}console.log("Sending participant update:",a),this.socket.emit("participant-update",{callId:t,updates:a,targetUserId:s,fromUserId:this.config.userId})}onSignalingMessage(t,a){this.messageHandlers.set(t,a)}offSignalingMessage(t){this.messageHandlers.delete(t)}onConnection(t,a){this.connectionHandlers.set(t,a)}offConnection(t){this.connectionHandlers.delete(t)}getConnectionStatus(){return this.isConnected}getSocket(){return this.socket}updateConfig(t){this.config={...this.config,...t}}joinDocument(t){if(!this.socket||!this.isConnected){console.error("Cannot join document: not connected to signaling server");return}console.log(`Joining document room: ${t}`),this.socket.emit("join-document",t),this.config.documentId=t}leaveDocument(t){if(!this.socket||!this.isConnected){console.error("Cannot leave document: not connected to signaling server");return}console.log(`Leaving document room: ${t}`),this.socket.emit("leave-document",t)}}let fe=null;function $s(r){return fe&&fe.disconnect(),fe=new Ps(r),fe}const Y=class Y{constructor(){_(this,"errorHistory",[]);_(this,"maxHistorySize",50)}static getInstance(){return Y.instance||(Y.instance=new Y),Y.instance}handleError(t,a){const s=this.categorizeError(t,a);return this.logError(s),s}categorizeError(t,a){const s=(t==null?void 0:t.message)||(t==null?void 0:t.toString())||"Unknown error",n=(t==null?void 0:t.name)||"UnknownError";return n==="NotAllowedError"||s.includes("Permission denied")?{code:"MEDIA_PERMISSION_DENIED",message:s,severity:"high",recoverable:!0,userMessage:"Camera and microphone access was denied. Please allow access and try again.",technicalDetails:`${n}: ${s}`,suggestedActions:["Click the camera/microphone icon in your browser address bar",'Select "Allow" for camera and microphone permissions',"Refresh the page and try again"]}:n==="NotFoundError"||s.includes("Requested device not found")?{code:"MEDIA_DEVICE_NOT_FOUND",message:s,severity:"medium",recoverable:!0,userMessage:"Camera or microphone not found. Please check your devices.",technicalDetails:`${n}: ${s}`,suggestedActions:["Check that your camera and microphone are connected","Try refreshing the page","Check device settings in your operating system"]}:n==="NotReadableError"||s.includes("Could not start video source")?{code:"MEDIA_DEVICE_IN_USE",message:s,severity:"medium",recoverable:!0,userMessage:"Your camera or microphone is being used by another application.",technicalDetails:`${n}: ${s}`,suggestedActions:["Close other applications that might be using your camera/microphone","Try refreshing the page","Restart your browser"]}:s.includes("ICE")||s.includes("connection failed")?{code:"ICE_CONNECTION_FAILED",message:s,severity:"high",recoverable:!0,userMessage:"Connection failed. This might be due to network restrictions.",technicalDetails:`ICE Connection Error: ${s}`,suggestedActions:["Check your internet connection","Try connecting from a different network","Contact your network administrator if on a corporate network"]}:s.includes("STUN")||s.includes("TURN")?{code:"STUN_TURN_ERROR",message:s,severity:"medium",recoverable:!0,userMessage:"Network configuration issue. Connection may be unstable.",technicalDetails:`STUN/TURN Error: ${s}`,suggestedActions:["Try again in a few moments","Check your firewall settings","Try connecting from a different network"]}:s.includes("signaling")||s.includes("websocket")?{code:"SIGNALING_ERROR",message:s,severity:"high",recoverable:!0,userMessage:"Connection to the server failed. Please try again.",technicalDetails:`Signaling Error: ${s}`,suggestedActions:["Check your internet connection","Refresh the page","Try again in a few moments"]}:s.includes("not supported")||s.includes("undefined")?{code:"BROWSER_NOT_SUPPORTED",message:s,severity:"critical",recoverable:!1,userMessage:"Your browser does not support video calling. Please use a modern browser.",technicalDetails:`Browser Compatibility: ${s}`,suggestedActions:["Update your browser to the latest version","Try using Chrome, Firefox, Safari, or Edge","Enable WebRTC in your browser settings"]}:a==="webrtc"||s.includes("peer")||s.includes("RTC")?{code:"WEBRTC_GENERIC_ERROR",message:s,severity:"medium",recoverable:!0,userMessage:"A connection error occurred. Please try again.",technicalDetails:`WebRTC Error: ${s}`,suggestedActions:["Try ending and starting the call again","Refresh the page","Check your internet connection"]}:{code:"UNKNOWN_ERROR",message:s,severity:"medium",recoverable:!0,userMessage:"An unexpected error occurred. Please try again.",technicalDetails:`Unknown Error: ${s}`,suggestedActions:["Try refreshing the page","Check your internet connection","Contact support if the problem persists"]}}logError(t){this.errorHistory.unshift({...t,message:`${new Date().toISOString()}: ${t.message}`}),this.errorHistory.length>this.maxHistorySize&&(this.errorHistory=this.errorHistory.slice(0,this.maxHistorySize));const a=`[WebRTC Error] ${t.code}: ${t.userMessage}`,s=t.technicalDetails||t.message;switch(t.severity){case"critical":console.error(a,s);break;case"high":console.error(a,s);break;case"medium":console.warn(a,s);break;case"low":console.info(a,s);break}}getErrorHistory(){return[...this.errorHistory]}clearErrorHistory(){this.errorHistory=[]}getRecoveryActions(t){const a=this.errorHistory.find(s=>s.code===t);return(a==null?void 0:a.suggestedActions)||[]}async attemptRecovery(t,a){if(!t.recoverable)return!1;switch(t.code){case"MEDIA_PERMISSION_DENIED":return!1;case"MEDIA_DEVICE_NOT_FOUND":case"MEDIA_DEVICE_IN_USE":if(a){await new Promise(s=>setTimeout(s,2e3));try{return await a(),!0}catch(s){return this.handleError(s,"recovery_attempt"),!1}}return!1;case"ICE_CONNECTION_FAILED":case"STUN_TURN_ERROR":if(a){await new Promise(s=>setTimeout(s,5e3));try{return await a(),!0}catch(s){return this.handleError(s,"recovery_attempt"),!1}}return!1;case"SIGNALING_ERROR":if(a){await new Promise(s=>setTimeout(s,3e3));try{return await a(),!0}catch(s){return this.handleError(s,"recovery_attempt"),!1}}return!1;default:return!1}}generateErrorReport(){const t={timestamp:new Date().toISOString(),userAgent:navigator.userAgent,webrtcSupport:{rtcPeerConnection:!!window.RTCPeerConnection,getUserMedia:!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia),getDisplayMedia:!!(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)},errorHistory:this.errorHistory.slice(0,10),browserInfo:{language:navigator.language,platform:navigator.platform,cookieEnabled:navigator.cookieEnabled,onLine:navigator.onLine}};return JSON.stringify(t,null,2)}};_(Y,"instance");let Ee=Y;const Ue=Ee.getInstance();function Ye(r={}){const{initializeWebRTC:t,startCall:a,acceptCall:s,rejectCall:n,endCall:o,toggleVideo:d,toggleAudio:p,toggleScreenShare:C,handleSignalingMessage:S,createPeerConnection:h,addParticipant:I,removeParticipant:U,updateParticipant:y,setError:N,cleanup:g,isInCall:E,isInitiating:A,isReceivingCall:T,callId:x,localStream:M,remoteStreams:P,participants:$,isVideoEnabled:R,isAudioEnabled:D,isSharingScreen:z,callStartTime:V,callDuration:F,lastError:i,peerConnections:v}=ge(),u=l.useRef(null),m=l.useRef(null);l.useEffect(()=>((async()=>{try{await t(),m.current||(m.current=$s({serverUrl:Us.getSignalingServerUrl(),userId:"current-user",documentId:"current-document",autoConnect:!0}),m.current.onSignalingMessage("webrtc-hook",se))}catch(f){console.error("Failed to initialize WebRTC/Signaling:",f);const w=Ue.handleError(f,"initialization");N(w.userMessage)}})(),()=>{g(),u.current&&clearInterval(u.current),m.current&&(m.current.offSignalingMessage("webrtc-hook"),m.current.disconnect(),m.current=null)}),[t,g]),l.useEffect(()=>(E&&V?u.current=setInterval(()=>{const c=Math.floor((Date.now()-V.getTime())/1e3);ge.setState({callDuration:c})},1e3):u.current&&(clearInterval(u.current),u.current=null),()=>{u.current&&clearInterval(u.current)}),[E,V]),l.useEffect(()=>{i&&r.onError&&r.onError(i)},[i,r.onError]);const W=l.useCallback(async c=>{try{await a(c),m.current&&x&&m.current.sendCallRequest(c,x,"Current User");const f=await h(c);if(f){const w=await f.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});if(await f.setLocalDescription(w),m.current){const L={type:"offer",callId:x,fromUserId:"current-user",toUserId:c,data:w};m.current.sendSignalingMessage(L),console.log("Sent offer to",c)}}}catch(f){console.error("Failed to initiate call:",f);const w=Ue.handleError(f,"call_initiation");throw N(w.userMessage),f}},[a,x,h]),q=l.useCallback(async(c,f)=>{try{await s(c),m.current&&m.current.respondToCall(c,!0,f),console.log(`Accepted call from ${f}`),r.onCallReceived&&r.onCallReceived(c,f)}catch(w){throw console.error("Failed to accept call:",w),w}},[s,r]),O=l.useCallback((c,f)=>{n(c),m.current&&m.current.respondToCall(c,!1,f),console.log(`Rejected call from ${f}`)},[n]),k=l.useCallback(()=>{m.current&&x&&m.current.endCall(x),o(),r.onCallEnded&&r.onCallEnded()},[o,x,r]),pe=l.useCallback(async()=>{await d(),m.current&&x&&m.current.sendParticipantUpdate(x,{isVideoEnabled:!R})},[d,x,R]),ve=l.useCallback(async()=>{await p(),m.current&&x&&m.current.sendParticipantUpdate(x,{isAudioEnabled:!D})},[p,x,D]),oe=l.useCallback(async()=>{await C(),m.current&&x&&m.current.sendParticipantUpdate(x,{isSharingScreen:!z})},[C,x,z]),se=l.useCallback(async c=>{try{switch(c.type){case"offer":const f=await h(c.fromUserId);await f.setRemoteDescription(c.data);const w=await f.createAnswer();await f.setLocalDescription(w);const L={type:"answer",callId:c.callId,fromUserId:"current-user",toUserId:c.fromUserId,data:w};console.log("Sending answer:",L);break;case"answer":const Z=v.get(c.fromUserId);Z&&await Z.connection.setRemoteDescription(c.data);break;case"ice-candidate":const ae=v.get(c.fromUserId);ae&&await ae.connection.addIceCandidate(c.data);break;case"call-request":!E&&!A?(ge.setState({isReceivingCall:!0,callId:c.callId}),r.onCallReceived&&r.onCallReceived(c.callId,c.fromUserId)):m.current&&m.current.respondToCall(c.callId,!1,c.fromUserId);break;case"call-accept":console.log("Call accepted by",c.fromUserId),I({userId:c.fromUserId,isVideoEnabled:!0,isAudioEnabled:!0,isSharingScreen:!1});break;case"call-reject":console.log("Call rejected by",c.fromUserId),N("Call was rejected"),o();break;case"call-end":console.log("Call ended by",c.fromUserId),r.onCallEnded&&r.onCallEnded(),o();break;case"participant-update":y(c.fromUserId,c.data);break;default:console.warn("Unknown signaling message type:",c.type)}await S(c)}catch(f){console.error("Failed to process signaling message:",f),N(f instanceof Error?f.message:"Signaling error")}},[h,v,S,o,y,N,r]),J=l.useCallback(()=>({video:R?{width:{ideal:1280},height:{ideal:720},frameRate:{ideal:30}}:!1,audio:D?{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}:!1}),[R,D]),b=l.useCallback(async()=>{if(E)try{const c=J(),f=await navigator.mediaDevices.getUserMedia(c);v.forEach(w=>{const L=w.connection.getSenders();f.getTracks().forEach(Z=>{const ae=L.find(Re=>Re.track&&Re.track.kind===Z.kind);ae?ae.replaceTrack(Z):w.connection.addTrack(Z,f)})}),M&&M.getTracks().forEach(w=>w.stop()),ge.setState({localStream:f})}catch(c){console.error("Failed to update media stream:",c),N(c instanceof Error?c.message:"Media update failed")}},[E,J,v,M,N]),X=l.useCallback(c=>{const f=Math.floor(c/3600),w=Math.floor(c%3600/60),L=c%60;return f>0?`${f}:${w.toString().padStart(2,"0")}:${L.toString().padStart(2,"0")}`:`${w}:${L.toString().padStart(2,"0")}`},[]);return{isInCall:E,isInitiating:A,isReceivingCall:T,callId:x,localStream:M,remoteStreams:P,participants:$,isVideoEnabled:R,isAudioEnabled:D,isSharingScreen:z,callDuration:F,lastError:i,initiateCall:W,acceptIncomingCall:q,rejectIncomingCall:O,endCall:k,toggleVideo:pe,toggleAudio:ve,toggleScreenShare:oe,processSignalingMessage:se,updateMediaStream:b,formatCallDuration:X,getMediaConstraints:J}}function Ve({participant:r,stream:t,isLocal:a=!1,isPinned:s=!1,onPin:n,onUnpin:o,className:d=""}){var T;const p=l.useRef(null),[C,S]=l.useState(!1),[h,I]=l.useState(!1),[U,y]=l.useState(!1),{users:N}=Ie(),g=N.find(x=>x.id===r.userId);l.useEffect(()=>{p.current&&t&&(p.current.srcObject=t,p.current.onloadedmetadata=()=>{S(!0)})},[t]),l.useEffect(()=>{p.current&&a&&(p.current.style.transform="scaleX(-1)")},[a]);const E=()=>{p.current&&(p.current.muted=!p.current.muted,I(p.current.muted))},A=()=>{s&&o?o():!s&&n&&n()};return e.jsxs("div",{className:`relative bg-gray-900 rounded-lg overflow-hidden group ${d}`,onMouseEnter:()=>y(!0),onMouseLeave:()=>y(!1),children:[r.isVideoEnabled&&t?e.jsx("video",{ref:p,autoPlay:!0,playsInline:!0,muted:a,className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center bg-gradient-to-br from-gray-800 to-gray-900",children:e.jsxs(te,{className:"w-16 h-16 md:w-24 md:h-24",children:[e.jsx(re,{src:g==null?void 0:g.avatar,alt:g==null?void 0:g.name}),e.jsx(ne,{className:"bg-gradient-to-r from-blue-500 to-purple-600 text-white text-lg md:text-2xl",style:{backgroundColor:g==null?void 0:g.color},children:((T=g==null?void 0:g.name)==null?void 0:T.charAt(0))||"?"})]})}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("span",{className:"text-white text-sm font-medium truncate",children:[(g==null?void 0:g.name)||"Unknown User",a&&" (You)"]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[!r.isAudioEnabled&&e.jsx("div",{className:"p-1 bg-red-500 rounded-full",children:e.jsx(Te,{className:"w-3 h-3 text-white"})}),!r.isVideoEnabled&&e.jsx("div",{className:"p-1 bg-red-500 rounded-full",children:e.jsx(Oe,{className:"w-3 h-3 text-white"})}),r.isSharingScreen&&e.jsx("div",{className:"p-1 bg-blue-500 rounded-full",children:e.jsx(le,{className:"w-3 h-3 text-white"})})]})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("div",{className:"w-1 h-3 bg-green-500 rounded-full"}),e.jsx("div",{className:"w-1 h-2 bg-green-500 rounded-full"}),e.jsx("div",{className:"w-1 h-1 bg-gray-400 rounded-full"})]})]})}),U&&e.jsxs("div",{className:"absolute top-2 right-2 flex items-center space-x-1",children:[!a&&e.jsx(j,{variant:"ghost",size:"sm",onClick:E,className:"bg-black/50 hover:bg-black/70 text-white p-2",children:h?e.jsx(os,{className:"w-4 h-4"}):e.jsx(ds,{className:"w-4 h-4"})}),e.jsx(j,{variant:"ghost",size:"sm",onClick:A,className:"bg-black/50 hover:bg-black/70 text-white p-2",children:e.jsx(us,{className:`w-4 h-4 ${s?"text-blue-400":""}`})}),e.jsxs(Ne,{children:[e.jsx(Ce,{asChild:!0,children:e.jsx(j,{variant:"ghost",size:"sm",className:"bg-black/50 hover:bg-black/70 text-white p-2",children:e.jsx(_e,{className:"w-4 h-4"})})}),e.jsxs(we,{align:"end",className:"bg-gray-800 border-gray-700",children:[!a&&e.jsxs(e.Fragment,{children:[e.jsx(K,{className:"text-gray-200 hover:bg-gray-700",children:"View Profile"}),e.jsx(K,{className:"text-gray-200 hover:bg-gray-700",children:"Send Message"})]}),e.jsx(K,{className:"text-gray-200 hover:bg-gray-700",children:s?"Unpin Video":"Pin Video"})]})]})]}),r.isVideoEnabled&&t&&!C&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-gray-900",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"})}),s&&e.jsx(ie,{className:"absolute top-2 left-2 bg-blue-600 text-white",children:"Pinned"}),r.isSharingScreen&&e.jsxs(ie,{className:"absolute top-2 left-2 bg-green-600 text-white flex items-center space-x-1",children:[e.jsx(le,{className:"w-3 h-3"}),e.jsx("span",{children:"Sharing Screen"})]})]})}function zs({isInCall:r=!1}){const[t,a]=l.useState([]),[s,n]=l.useState([]),[o,d]=l.useState(""),[p,C]=l.useState(""),[S,h]=l.useState(""),[I,U]=l.useState([75]),[y,N]=l.useState([75]),[g,E]=l.useState("720p"),[A,T]=l.useState(!0),[x,M]=l.useState(!0),[P,$]=l.useState(!0),[R,D]=l.useState(!1),[z,V]=l.useState(!1);l.useEffect(()=>{(async()=>{try{const m=await navigator.mediaDevices.enumerateDevices();a(m.filter(k=>k.kind==="audioinput"||k.kind==="audiooutput")),n(m.filter(k=>k.kind==="videoinput"));const W=m.find(k=>k.kind==="audioinput"&&k.deviceId==="default"),q=m.find(k=>k.kind==="audiooutput"&&k.deviceId==="default"),O=m.find(k=>k.kind==="videoinput"&&k.deviceId==="default");W&&d(W.deviceId),q&&C(q.deviceId),O&&h(O.deviceId)}catch(m){console.error("Failed to load media devices:",m)}})()},[]);const F=async()=>{D(!0);try{const u=await navigator.mediaDevices.getUserMedia({audio:{deviceId:o?{exact:o}:void 0,echoCancellation:A,noiseSuppression:x,autoGainControl:P}}),m=new AudioContext,W=m.createAnalyser();m.createMediaStreamSource(u).connect(W),setTimeout(()=>{u.getTracks().forEach(O=>O.stop()),m.close(),D(!1)},3e3)}catch(u){console.error("Microphone test failed:",u),D(!1)}},i=async()=>{V(!0);try{const u=await navigator.mediaDevices.getUserMedia({video:{deviceId:S?{exact:S}:void 0,width:{ideal:g==="1080p"?1920:g==="720p"?1280:640},height:{ideal:g==="1080p"?1080:g==="720p"?720:480}}});setTimeout(()=>{u.getTracks().forEach(m=>m.stop()),V(!1)},3e3)}catch(u){console.error("Camera test failed:",u),V(!1)}},v=u=>{switch(u){case"1080p":return"High quality (1920x1080) - Uses more bandwidth";case"720p":return"Standard quality (1280x720) - Recommended";case"480p":return"Low quality (640x480) - Uses less bandwidth";default:return""}};return e.jsxs(We,{children:[e.jsx(Ss,{asChild:!0,children:e.jsx(j,{variant:"ghost",size:"sm",className:"p-2",children:e.jsx(Me,{className:"w-4 h-4"})})}),e.jsxs(Le,{className:"max-w-2xl bg-gray-900 border-gray-700 text-white",children:[e.jsxs(Ge,{children:[e.jsxs(qe,{className:"flex items-center space-x-2",children:[e.jsx(Me,{className:"w-5 h-5"}),e.jsx("span",{children:"Media Settings"})]}),e.jsx(Be,{className:"text-gray-400",children:"Configure your audio and video settings for the best call experience"})]}),e.jsxs(Es,{defaultValue:"audio",className:"w-full",children:[e.jsxs(Is,{className:"grid w-full grid-cols-3 bg-gray-800",children:[e.jsxs(je,{value:"audio",className:"data-[state=active]:bg-gray-700",children:[e.jsx(xe,{className:"w-4 h-4 mr-2"}),"Audio"]}),e.jsxs(je,{value:"video",className:"data-[state=active]:bg-gray-700",children:[e.jsx(ce,{className:"w-4 h-4 mr-2"}),"Video"]}),e.jsxs(je,{value:"advanced",className:"data-[state=active]:bg-gray-700",children:[e.jsx(le,{className:"w-4 h-4 mr-2"}),"Advanced"]})]}),e.jsx(ye,{value:"audio",className:"space-y-6",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(H,{className:"text-sm font-medium text-gray-200",children:"Microphone"}),e.jsxs(de,{value:o,onValueChange:d,children:[e.jsx(ue,{className:"bg-gray-800 border-gray-600",children:e.jsx(me,{placeholder:"Select microphone"})}),e.jsx(he,{className:"bg-gray-800 border-gray-600",children:t.filter(u=>u.kind==="audioinput").map(u=>e.jsx(ee,{value:u.deviceId,children:u.label||`Microphone ${u.deviceId.slice(0,8)}`},u.deviceId))})]})]}),e.jsxs("div",{children:[e.jsx(H,{className:"text-sm font-medium text-gray-200",children:"Speakers"}),e.jsxs(de,{value:p,onValueChange:C,children:[e.jsx(ue,{className:"bg-gray-800 border-gray-600",children:e.jsx(me,{placeholder:"Select speakers"})}),e.jsx(he,{className:"bg-gray-800 border-gray-600",children:t.filter(u=>u.kind==="audiooutput").map(u=>e.jsx(ee,{value:u.deviceId,children:u.label||`Speaker ${u.deviceId.slice(0,8)}`},u.deviceId))})]})]}),e.jsxs("div",{children:[e.jsx(H,{className:"text-sm font-medium text-gray-200",children:"Microphone Volume"}),e.jsx(Ae,{value:I,onValueChange:U,max:100,step:1,className:"mt-2"}),e.jsxs("div",{className:"text-xs text-gray-400 mt-1",children:[I[0],"%"]})]}),e.jsxs("div",{children:[e.jsx(H,{className:"text-sm font-medium text-gray-200",children:"Speaker Volume"}),e.jsx(Ae,{value:y,onValueChange:N,max:100,step:1,className:"mt-2"}),e.jsxs("div",{className:"text-xs text-gray-400 mt-1",children:[y[0],"%"]})]}),e.jsxs(j,{onClick:F,disabled:R,className:"w-full bg-blue-600 hover:bg-blue-700",children:[e.jsx(De,{className:"w-4 h-4 mr-2"}),R?"Testing Microphone...":"Test Microphone"]})]})}),e.jsx(ye,{value:"video",className:"space-y-6",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(H,{className:"text-sm font-medium text-gray-200",children:"Camera"}),e.jsxs(de,{value:S,onValueChange:h,children:[e.jsx(ue,{className:"bg-gray-800 border-gray-600",children:e.jsx(me,{placeholder:"Select camera"})}),e.jsx(he,{className:"bg-gray-800 border-gray-600",children:s.map(u=>e.jsx(ee,{value:u.deviceId,children:u.label||`Camera ${u.deviceId.slice(0,8)}`},u.deviceId))})]})]}),e.jsxs("div",{children:[e.jsx(H,{className:"text-sm font-medium text-gray-200",children:"Video Quality"}),e.jsxs(de,{value:g,onValueChange:E,children:[e.jsx(ue,{className:"bg-gray-800 border-gray-600",children:e.jsx(me,{})}),e.jsxs(he,{className:"bg-gray-800 border-gray-600",children:[e.jsx(ee,{value:"1080p",children:"1080p (High)"}),e.jsx(ee,{value:"720p",children:"720p (Standard)"}),e.jsx(ee,{value:"480p",children:"480p (Low)"})]})]}),e.jsx("div",{className:"text-xs text-gray-400 mt-1",children:v(g)})]}),e.jsxs(j,{onClick:i,disabled:z,className:"w-full bg-blue-600 hover:bg-blue-700",children:[e.jsx(De,{className:"w-4 h-4 mr-2"}),z?"Testing Camera...":"Test Camera"]})]})}),e.jsx(ye,{value:"advanced",className:"space-y-6",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(H,{className:"text-sm font-medium text-gray-200",children:"Echo Cancellation"}),e.jsx("p",{className:"text-xs text-gray-400",children:"Reduces echo from speakers"})]}),e.jsx(be,{checked:A,onCheckedChange:T})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(H,{className:"text-sm font-medium text-gray-200",children:"Noise Suppression"}),e.jsx("p",{className:"text-xs text-gray-400",children:"Reduces background noise"})]}),e.jsx(be,{checked:x,onCheckedChange:M})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(H,{className:"text-sm font-medium text-gray-200",children:"Auto Gain Control"}),e.jsx("p",{className:"text-xs text-gray-400",children:"Automatically adjusts microphone volume"})]}),e.jsx(be,{checked:P,onCheckedChange:$})]}),r&&e.jsxs("div",{className:"mt-6 p-4 bg-gray-800 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(ms,{className:"w-4 h-4 text-blue-400"}),e.jsx("span",{className:"text-sm font-medium text-gray-200",children:"Call Information"})]}),e.jsxs("div",{className:"space-y-1 text-xs text-gray-400",children:[e.jsx("div",{children:"Connection: WebRTC P2P"}),e.jsx("div",{children:"Audio Codec: Opus"}),e.jsx("div",{children:"Video Codec: VP8/H.264"}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(hs,{className:"w-3 h-3"}),e.jsx("span",{children:"Connection Quality: Good"})]})]})]})]})})]})]})]})}const Os=l.forwardRef(({className:r,children:t,...a},s)=>e.jsxs(Pe,{ref:s,className:ke("relative overflow-hidden",r),...a,children:[e.jsx(Ze,{className:"h-full w-full rounded-[inherit]",children:t}),e.jsx(Ke,{}),e.jsx(es,{})]}));Os.displayName=Pe.displayName;const Ke=l.forwardRef(({className:r,orientation:t="vertical",...a},s)=>e.jsx($e,{ref:s,orientation:t,className:ke("flex touch-none select-none transition-colors",t==="vertical"&&"h-full w-2.5 border-l border-l-transparent p-[1px]",t==="horizontal"&&"h-2.5 flex-col border-t border-t-transparent p-[1px]",r),...a,children:e.jsx(ss,{className:"relative flex-1 rounded-full bg-zinc-200 dark:bg-zinc-800"})}));Ke.displayName=$e.displayName;const _s=as,B=ts,Q=rs,G=l.forwardRef(({className:r,sideOffset:t=4,...a},s)=>e.jsx(ns,{children:e.jsx(ze,{ref:s,sideOffset:t,className:ke("z-50 overflow-hidden rounded-md bg-zinc-900 px-3 py-1.5 text-xs text-zinc-50 animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 dark:bg-zinc-50 dark:text-zinc-900",r),...a})}));G.displayName=ze.displayName;function Hs({isVideoEnabled:r,isAudioEnabled:t,isSharingScreen:a,isInCall:s,participantCount:n,callDuration:o,onToggleVideo:d,onToggleAudio:p,onToggleScreenShare:C,onEndCall:S,onToggleChat:h,onToggleParticipants:I,onToggleFullscreen:U,isFullscreen:y=!1,isChatOpen:N=!1,isParticipantsOpen:g=!1,className:E=""}){const[A,T]=l.useState(!1),x=M=>{const P=Math.floor(M/3600),$=Math.floor(M%3600/60),R=M%60;return P>0?`${P}:${$.toString().padStart(2,"0")}:${R.toString().padStart(2,"0")}`:`${$}:${R.toString().padStart(2,"0")}`};return s?e.jsx(_s,{children:e.jsxs("div",{className:`bg-gray-900/95 backdrop-blur-sm border-t border-gray-700 p-4 ${E}`,children:[e.jsxs("div",{className:"flex items-center justify-between max-w-4xl mx-auto",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs(ie,{variant:"secondary",className:"bg-green-600 text-white",children:[e.jsx("div",{className:"w-2 h-2 bg-white rounded-full mr-2 animate-pulse"}),"Live"]}),e.jsx("span",{className:"text-gray-300 text-sm font-mono",children:x(o)}),e.jsxs("div",{className:"flex items-center space-x-1 text-gray-400",children:[e.jsx(Se,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:n})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs(B,{children:[e.jsx(Q,{asChild:!0,children:e.jsx(j,{variant:"ghost",size:"lg",onClick:p,className:`rounded-full p-3 ${t?"bg-gray-700 hover:bg-gray-600 text-white":"bg-red-600 hover:bg-red-700 text-white"}`,children:t?e.jsx(xe,{className:"w-5 h-5"}):e.jsx(Te,{className:"w-5 h-5"})})}),e.jsx(G,{children:t?"Mute microphone":"Unmute microphone"})]}),e.jsxs(B,{children:[e.jsx(Q,{asChild:!0,children:e.jsx(j,{variant:"ghost",size:"lg",onClick:d,className:`rounded-full p-3 ${r?"bg-gray-700 hover:bg-gray-600 text-white":"bg-red-600 hover:bg-red-700 text-white"}`,children:r?e.jsx(ce,{className:"w-5 h-5"}):e.jsx(Oe,{className:"w-5 h-5"})})}),e.jsx(G,{children:r?"Turn off camera":"Turn on camera"})]}),e.jsxs(B,{children:[e.jsx(Q,{asChild:!0,children:e.jsx(j,{variant:"ghost",size:"lg",onClick:C,className:`rounded-full p-3 ${a?"bg-blue-600 hover:bg-blue-700 text-white":"bg-gray-700 hover:bg-gray-600 text-white"}`,children:a?e.jsx(gs,{className:"w-5 h-5"}):e.jsx(le,{className:"w-5 h-5"})})}),e.jsx(G,{children:a?"Stop sharing screen":"Share screen"})]}),e.jsxs(B,{children:[e.jsx(Q,{asChild:!0,children:e.jsx(j,{variant:"destructive",size:"lg",onClick:S,className:"rounded-full p-3 bg-red-600 hover:bg-red-700",children:e.jsx(He,{className:"w-5 h-5"})})}),e.jsx(G,{children:"End call"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[h&&e.jsxs(B,{children:[e.jsx(Q,{asChild:!0,children:e.jsx(j,{variant:"ghost",size:"sm",onClick:h,className:`p-2 ${N?"bg-blue-600 hover:bg-blue-700 text-white":"bg-gray-700 hover:bg-gray-600 text-gray-300"}`,children:e.jsx(fs,{className:"w-4 h-4"})})}),e.jsx(G,{children:N?"Hide chat":"Show chat"})]}),I&&e.jsxs(B,{children:[e.jsx(Q,{asChild:!0,children:e.jsx(j,{variant:"ghost",size:"sm",onClick:I,className:`p-2 ${g?"bg-blue-600 hover:bg-blue-700 text-white":"bg-gray-700 hover:bg-gray-600 text-gray-300"}`,children:e.jsx(Se,{className:"w-4 h-4"})})}),e.jsx(G,{children:g?"Hide participants":"Show participants"})]}),U&&e.jsxs(B,{children:[e.jsx(Q,{asChild:!0,children:e.jsx(j,{variant:"ghost",size:"sm",onClick:U,className:"p-2 bg-gray-700 hover:bg-gray-600 text-gray-300",children:y?e.jsx(xs,{className:"w-4 h-4"}):e.jsx(ps,{className:"w-4 h-4"})})}),e.jsx(G,{children:y?"Exit fullscreen":"Enter fullscreen"})]}),e.jsx(zs,{isInCall:s}),!1]})]}),a&&e.jsx("div",{className:"mt-3 flex items-center justify-center",children:e.jsxs(ie,{className:"bg-blue-600 text-white flex items-center space-x-2",children:[e.jsx(le,{className:"w-4 h-4"}),e.jsx("span",{children:"You are sharing your screen"})]})})]})}):null}function Fs({isOpen:r,onClose:t,targetUserId:a,className:s=""}){var se,J;const[n,o]=l.useState(!1),[d,p]=l.useState(null),[C,S]=l.useState(!1),[h,I]=l.useState(null),{users:U}=Ie(),{isInCall:y,isInitiating:N,isReceivingCall:g,localStream:E,remoteStreams:A,participants:T,isVideoEnabled:x,isAudioEnabled:M,isSharingScreen:P,callDuration:$,lastError:R,initiateCall:D,acceptIncomingCall:z,rejectIncomingCall:V,endCall:F,toggleVideo:i,toggleAudio:v,toggleScreenShare:u}=Ye({onCallReceived:(b,X)=>{const c=U.find(f=>f.id===X);I({callId:b,fromUserId:X,fromUserName:c==null?void 0:c.name}),S(!0)},onCallEnded:()=>{S(!1),I(null),t()},onError:b=>{console.error("WebRTC Error:",b)}});l.useEffect(()=>{r&&a&&!y&&!N&&D(a).catch(console.error)},[r,a,y,N,D]),l.useEffect(()=>{g&&!C&&S(!0)},[g,C]);const m=l.useCallback(async()=>{if(h)try{await z(h.callId,h.fromUserId),S(!1),I(null)}catch(b){console.error("Failed to accept call:",b)}},[h,z]),W=l.useCallback(()=>{h&&(V(h.callId,h.fromUserId),S(!1),I(null),t())},[h,V,t]),q=l.useCallback(()=>{F(),t()},[F,t]),O=l.useCallback(b=>{p(b===d?null:b)},[d]),k=l.useCallback(()=>{o(!n)},[n]),pe=()=>d&&d!=="local"?A.get(d):E,ve=()=>d&&d!=="local"?T.find(b=>b.userId===d):T.find(b=>b.userId==="current-user")||T[0],oe=()=>{const b=d||"local";return T.filter(X=>X.userId!==b)};return r?e.jsxs(e.Fragment,{children:[e.jsx(We,{open:C,onOpenChange:S,children:e.jsxs(Le,{className:"bg-gray-900 border-gray-700 text-white",children:[e.jsxs(Ge,{children:[e.jsxs(qe,{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-3 h-3 bg-green-500 rounded-full animate-pulse"}),"Incoming Call"]}),e.jsxs(Be,{className:"text-gray-300",children:[(h==null?void 0:h.fromUserName)||"Unknown User"," is calling you"]})]}),e.jsx("div",{className:"flex items-center justify-center space-x-4 py-6",children:e.jsxs(te,{className:"w-20 h-20",children:[e.jsx(re,{src:(se=U.find(b=>b.id===(h==null?void 0:h.fromUserId)))==null?void 0:se.avatar,alt:h==null?void 0:h.fromUserName}),e.jsx(ne,{className:"bg-gradient-to-r from-blue-500 to-purple-600 text-white text-2xl",children:((J=h==null?void 0:h.fromUserName)==null?void 0:J.charAt(0))||"?"})]})}),e.jsxs("div",{className:"flex items-center justify-center space-x-4",children:[e.jsx(j,{variant:"destructive",size:"lg",onClick:W,className:"rounded-full p-4",children:e.jsx(He,{className:"w-6 h-6"})}),e.jsx(j,{variant:"default",size:"lg",onClick:m,className:"rounded-full p-4 bg-green-600 hover:bg-green-700",children:e.jsx(Fe,{className:"w-6 h-6"})})]})]})}),e.jsxs("div",{className:`fixed inset-0 bg-black z-50 flex flex-col ${s}`,children:[e.jsxs("div",{className:"flex-1 flex",children:[e.jsxs("div",{className:"flex-1 relative",children:[y?e.jsx(Ve,{participant:ve(),stream:pe(),isLocal:d==="local"||!d,isPinned:!!d,onPin:()=>O("local"),onUnpin:()=>p(null),className:"w-full h-full"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center bg-gray-900",children:e.jsx("div",{className:"text-center",children:N?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"}),e.jsx("p",{className:"text-white text-lg",children:"Connecting..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(ce,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-400 text-lg",children:"Waiting to connect"})]})})}),e.jsx(j,{variant:"ghost",size:"sm",onClick:k,className:"absolute top-4 right-4 bg-black/50 hover:bg-black/70 text-white",children:n?e.jsx(vs,{className:"w-4 h-4"}):e.jsx(bs,{className:"w-4 h-4"})})]}),y&&oe().length>0&&e.jsxs("div",{className:"w-64 bg-gray-800 p-4 space-y-4 overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center space-x-2 text-white",children:[e.jsx(Se,{className:"w-4 h-4"}),e.jsxs("span",{className:"text-sm font-medium",children:["Participants (",T.length,")"]})]}),oe().map(b=>e.jsx(Ve,{participant:b,stream:A.get(b.userId),isPinned:d===b.userId,onPin:()=>O(b.userId),onUnpin:()=>p(null),className:"aspect-video"},b.userId))]})]}),e.jsx(Hs,{isVideoEnabled:x,isAudioEnabled:M,isSharingScreen:P,isInCall:y,participantCount:T.length,callDuration:$,onToggleVideo:i,onToggleAudio:v,onToggleScreenShare:u,onEndCall:q,onToggleFullscreen:k,isFullscreen:n}),R&&e.jsx("div",{className:"absolute top-4 left-1/2 transform -translate-x-1/2 bg-red-600 text-white px-4 py-2 rounded-lg",children:R})]})]}):null}function ua(){const{chatMessages:r,addChatMessage:t,users:a,isTyping:s,setIsTyping:n,typingUsers:o}=Ie(),[d,p]=l.useState(""),[C,S]=l.useState(!1),[h,I]=l.useState(!1),[U,y]=l.useState(null),N=l.useRef(null),{isInCall:g,isInitiating:E}=Ye(),A=()=>{var i;(i=N.current)==null||i.scrollIntoView({behavior:"smooth"})};l.useEffect(()=>{A()},[r]);const T=()=>{if(!d.trim())return;const i={id:`msg-${Date.now()}`,userId:"user-1",content:d,timestamp:new Date().toISOString(),type:"text"};t(i),p(""),n(!1)},x=i=>{i.key==="Enter"&&!i.shiftKey&&(i.preventDefault(),T())},M=i=>{p(i.target.value),n(i.target.value.length>0)},P=()=>{S(!C)},$=i=>{y(i||null),I(!0)},R=i=>{y(i||null),I(!0)},D=()=>{I(!1),y(null)},z=i=>ws(new Date(i),{addSuffix:!0}),V=i=>a.find(v=>v.id===i),F=i=>{var m;const v=V(i.userId),u=i.userId==="user-1";return e.jsxs("div",{className:`flex space-x-3 ${u?"flex-row-reverse space-x-reverse":""}`,children:[e.jsxs(te,{className:"w-8 h-8 flex-shrink-0",children:[e.jsx(re,{src:v==null?void 0:v.avatar,alt:v==null?void 0:v.name}),e.jsx(ne,{className:"bg-gradient-to-r from-blue-500 to-purple-600 text-white text-xs",children:((m=v==null?void 0:v.name)==null?void 0:m.charAt(0))||"?"})]}),e.jsxs("div",{className:`flex-1 max-w-xs ${u?"items-end":"items-start"} flex flex-col`,children:[e.jsx("div",{className:`rounded-lg px-3 py-2 ${u?"bg-blue-600 text-white":"bg-[#0f1419] border border-gray-700 text-gray-200"}`,children:i.type==="voice"?e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-6 h-6 bg-green-500 rounded-full flex items-center justify-center",children:e.jsx(xe,{className:"w-3 h-3 text-white"})}),e.jsx("div",{className:"flex-1",children:e.jsx("div",{className:"w-24 h-2 bg-gray-300 rounded-full",children:e.jsx("div",{className:"w-12 h-2 bg-green-500 rounded-full"})})}),e.jsxs("span",{className:"text-xs opacity-75",children:[i.duration,"s"]})]}):e.jsx("p",{className:"text-sm",children:i.content})}),e.jsxs("div",{className:`flex items-center space-x-2 mt-1 ${u?"flex-row-reverse space-x-reverse":""}`,children:[e.jsx("span",{className:"text-xs text-gray-400",children:v==null?void 0:v.name}),e.jsx("span",{className:"text-xs text-gray-500",children:z(i.timestamp)})]})]})]},i.id)};return e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsx("div",{className:"p-4 border-b border-gray-800",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-200",children:"Team Chat"}),(g||E)&&e.jsx(ie,{className:"bg-green-600 text-white text-xs",children:E?"Connecting...":"In Call"})]}),e.jsxs("p",{className:"text-xs text-gray-400",children:[a.filter(i=>i.status==="online").length," online"]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs(Ne,{children:[e.jsx(Ce,{asChild:!0,children:e.jsx(j,{variant:"ghost",size:"sm",className:"text-gray-400 hover:text-gray-200",disabled:g||E,children:e.jsx(Fe,{className:"w-4 h-4"})})}),e.jsxs(we,{align:"end",className:"bg-gray-800 border-gray-700",children:[e.jsxs(K,{onClick:()=>R(),className:"text-gray-200 hover:bg-gray-700",children:[e.jsx(js,{className:"w-4 h-4 mr-2"}),"Start Audio Call"]}),a.filter(i=>i.status==="online"&&i.id!=="user-1").map(i=>e.jsxs(K,{onClick:()=>R(i.id),className:"text-gray-200 hover:bg-gray-700",children:[e.jsxs(te,{className:"w-4 h-4 mr-2",children:[e.jsx(re,{src:i.avatar,alt:i.name}),e.jsx(ne,{className:"text-xs",style:{backgroundColor:i.color},children:i.name.charAt(0)})]}),"Call ",i.name]},i.id))]})]}),e.jsxs(Ne,{children:[e.jsx(Ce,{asChild:!0,children:e.jsx(j,{variant:"ghost",size:"sm",className:"text-gray-400 hover:text-gray-200",disabled:g||E,children:e.jsx(ce,{className:"w-4 h-4"})})}),e.jsxs(we,{align:"end",className:"bg-gray-800 border-gray-700",children:[e.jsxs(K,{onClick:()=>$(),className:"text-gray-200 hover:bg-gray-700",children:[e.jsx(ce,{className:"w-4 h-4 mr-2"}),"Start Video Call"]}),a.filter(i=>i.status==="online"&&i.id!=="user-1").map(i=>e.jsxs(K,{onClick:()=>$(i.id),className:"text-gray-200 hover:bg-gray-700",children:[e.jsxs(te,{className:"w-4 h-4 mr-2",children:[e.jsx(re,{src:i.avatar,alt:i.name}),e.jsx(ne,{className:"text-xs",style:{backgroundColor:i.color},children:i.name.charAt(0)})]}),"Video call ",i.name]},i.id))]})]}),e.jsx(j,{variant:"ghost",size:"sm",className:"text-gray-400 hover:text-gray-200",children:e.jsx(_e,{className:"w-4 h-4"})})]})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[r.map(F),o.length>0&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full animate-bounce [animation-delay:-0.3s]"}),e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full animate-bounce [animation-delay:-0.15s]"}),e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full animate-bounce"})]}),e.jsxs("span",{className:"text-xs text-gray-400",children:[o.join(", ")," ",o.length===1?"is":"are"," typing..."]})]}),e.jsx("div",{ref:N})]}),e.jsxs("div",{className:"p-4 border-t border-gray-800",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(j,{variant:"ghost",size:"sm",className:"text-gray-400 hover:text-gray-200",children:e.jsx(ys,{className:"w-4 h-4"})}),e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(cs,{value:d,onChange:M,onKeyPress:x,placeholder:"Type a message...",className:"bg-[#0f1419] border-gray-600 text-gray-200 pr-20"}),e.jsx(j,{variant:"ghost",size:"sm",className:"absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-200",children:e.jsx(Ns,{className:"w-4 h-4"})})]}),e.jsx(j,{variant:"ghost",size:"sm",onClick:P,className:`${C?"text-red-400":"text-gray-400"} hover:text-gray-200`,children:C?e.jsx(Te,{className:"w-4 h-4"}):e.jsx(xe,{className:"w-4 h-4"})}),e.jsx(j,{onClick:T,disabled:!d.trim(),size:"sm",className:"bg-blue-600 hover:bg-blue-700 text-white",children:e.jsx(Cs,{className:"w-4 h-4"})})]}),C&&e.jsxs("div",{className:"mt-2 flex items-center space-x-2 text-red-400",children:[e.jsx("div",{className:"w-2 h-2 bg-red-500 rounded-full animate-pulse"}),e.jsx("span",{className:"text-xs",children:"Recording voice message..."})]})]}),e.jsx(Fs,{isOpen:h,onClose:D,targetUserId:U||void 0})]})}export{ua as ChatPanel};
